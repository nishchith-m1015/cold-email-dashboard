{
  "name": "Email Tracking Injector",
  "nodes": [
    {
      "parameters": {
        "content": "## Email Tracking Injector\n\n**How to use:**\n1. Copy the 'üîç Inject Tracking' Code node\n2. Paste it into your Email 1, 2, 3 workflows\n3. Place it AFTER the email body is generated\n4. Place it BEFORE the Gmail send node\n5. Update the Gmail node to use `$json.tracked_body` instead of the original body\n\n**What it does:**\n- Adds a tracking pixel to detect email opens\n- Wraps links with click tracking URLs\n- Preserves original email formatting",
        "height": 400,
        "width": 450,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -200,
        200
      ],
      "typeVersion": 1,
      "id": "sticky-note-info",
      "name": "Instructions"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// EMAIL TRACKING INJECTOR\n// Adds open tracking pixel and click tracking\n// ============================================\n\nconst DASHBOARD_URL = 'https://cold-email-dashboard.vercel.app';\n\n// Get email data from previous nodes\nconst emailBody = $json.email_1_body || $json.email_2_body || $json.email_3_body || $json.body || '';\nconst contactEmail = $json.email_address || $json.contact_email || '';\nconst campaign = $json.state || $json.campaign || 'Ohio';\nconst step = $json.email_number || $json.step || 1;\n\n// Generate unique token for deduplication\nconst token = `${contactEmail}-${step}-${Date.now()}`;\nconst encodedToken = encodeURIComponent(Buffer.from(token).toString('base64'));\n\n// Build tracking pixel URL\nconst trackingPixelUrl = `${DASHBOARD_URL}/api/track/open?e=${encodeURIComponent(contactEmail)}&c=${encodeURIComponent(campaign)}&s=${step}&t=${encodedToken}`;\n\n// Build click tracking wrapper function\nfunction wrapLink(originalUrl, linkId = 'cta') {\n  const params = new URLSearchParams({\n    url: originalUrl,\n    e: contactEmail,\n    c: campaign,\n    s: step.toString(),\n    l: linkId\n  });\n  return `${DASHBOARD_URL}/api/track/click?${params.toString()}`;\n}\n\n// Process email body\nlet trackedBody = emailBody;\n\n// Wrap all <a href=\"...\"> links with click tracking\n// Match links in HTML format\nconst linkRegex = /<a\\s+([^>]*?)href=[\"']([^\"']+)[\"']([^>]*?)>/gi;\nlet linkIndex = 0;\ntrackedBody = trackedBody.replace(linkRegex, (match, before, url, after) => {\n  // Skip mailto: and tel: links\n  if (url.startsWith('mailto:') || url.startsWith('tel:') || url.startsWith('#')) {\n    return match;\n  }\n  linkIndex++;\n  const trackedUrl = wrapLink(url, `link_${linkIndex}`);\n  return `<a ${before}href=\"${trackedUrl}\"${after}>`;\n});\n\n// Also wrap plain text URLs (not in HTML tags)\n// This regex matches URLs that are not already in href attributes\nconst plainUrlRegex = /(?<!href=[\"'])\\b(https?:\\/\\/[^\\s<>\"']+)/gi;\ntrackedBody = trackedBody.replace(plainUrlRegex, (match, url) => {\n  // Check if this URL is already tracked\n  if (url.includes('/api/track/click')) {\n    return match;\n  }\n  linkIndex++;\n  return wrapLink(url, `plain_${linkIndex}`);\n});\n\n// Add tracking pixel at the end of the email\nconst trackingPixel = `<img src=\"${trackingPixelUrl}\" width=\"1\" height=\"1\" style=\"display:none;width:1px;height:1px;border:0;\" alt=\"\" />`;\n\n// If email is HTML, add before closing body tag or at end\nif (trackedBody.includes('</body>')) {\n  trackedBody = trackedBody.replace('</body>', `${trackingPixel}</body>`);\n} else if (trackedBody.includes('</html>')) {\n  trackedBody = trackedBody.replace('</html>', `${trackingPixel}</html>`);\n} else {\n  // Plain text or simple HTML - append at end\n  trackedBody = `${trackedBody}\\n${trackingPixel}`;\n}\n\n// Return modified item with tracked body\nreturn [\n  {\n    json: {\n      ...$json,\n      tracked_body: trackedBody,\n      original_body: emailBody,\n      tracking_pixel_url: trackingPixelUrl,\n      links_tracked: linkIndex,\n      tracking_token: encodedToken\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        400
      ],
      "id": "inject-tracking",
      "name": "üîç Inject Tracking"
    },
    {
      "parameters": {
        "content": "## Example Usage\n\n**Before (original flow):**\n```\nGenerate Email ‚Üí Gmail Send\n```\n\n**After (with tracking):**\n```\nGenerate Email ‚Üí üîç Inject Tracking ‚Üí Gmail Send\n```\n\n**In Gmail Send node, change:**\n- Body: `{{ $json.email_1_body }}`\n- To: `{{ $json.tracked_body }}`",
        "height": 280,
        "width": 350,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        600,
        200
      ],
      "typeVersion": 1,
      "id": "sticky-note-example",
      "name": "Example"
    }
  ],
  "pinData": {},
  "connections": {},
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "timezone": "America/Los_Angeles"
  },
  "versionId": "tracking-injector-v1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fb0f3042150127121074617aaee31b106c313805cbc452132240d35f72eba898"
  },
  "id": "tracking-injector-template",
  "tags": [
    {
      "id": "r8CZ5Y6mZ7dctfjE",
      "name": "Cold Email"
    }
  ]
}

